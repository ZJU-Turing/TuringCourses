# 嵌入式系统
<div class="badges">
<span class="badge cs-badge">CS 专业模块-计算机系统</span>
</div>

## 课程学习内容

这门课主要包括如下内容：

* bootloader，如何控制管理外设，包括设备驱动程序，以及嵌入式文件系统

* 嵌入式软件模型，包括裸机、RTOS 和嵌入式 Linux

* 通信与网络，包括有无线自组网、传感网、边缘计算等

* 嵌入式硬件、架构、平台，如何协同软硬件设计开发嵌入式系统

### 先修要求

* 操作系统原理与实践

* 计算机网络

本门课会用到大量操作系统相关的知识，如果没有学过操作系统将会寸步难行。wk 表示曾经有大一大二没学过操作系统的选课，最后听不懂只能退课/弃修。

网络也是本门课的教学内容之一，20 级 wk 班的大程就是对计网的工程实践，不过计网没学好不会像没学操作系统那样寸步难行，相对会边缘一些。

### 小实验要求

前期的实验多是嵌入式裸机编程以及 RTOS 编程，使用 C/C++ 在特定平台开发，需要把板子、开关等在面包板上接线进行实验。

后期的实验则会上 python，如 ESP32 板子上的 micropython 编程，以及嵌入式 Linux 上的 python 编程。不过 C/C++ 还是有用的，如嵌入式 Linux 上的字符驱动程序。

### 大程要求

=== "翁恺"

    20 级 wk 班的大程是将班中 50 人分为 4 个大组，每个大组都开发一套组内的自组网。

    * 对网络分层协议进行了简化，从物理层开始，经过数据链路层，网络层和传输层合一，应用层各组只需要跑通各自设计的一个应用程序即可

    * 分四次验收，分别验收物理层、数据链路层、网络层和应用层，每次构成基本分的 7 分

    * 各组互相合作，整个开发过程中进行协商，最后如果能实现组间网络互通，可以得到 4 分的加分

    19 级 wk 班的大程为三个方向选一，具体给分细则未知

    * 无线传感网：能量均衡的传播协议或室内定位

    * 边缘 AI：图像或声音的 AI 计算

    * 编程环境：micropython 的编程、调试、部署环境

=== "王总辉"

    20 级 wzh 班的大程是 4 人一组用 rk3568 板运行神经网络和摄像头做一件事情，比如人脸识别、车牌识别

    * 其实不是很难，神经网络什么可以直接用开源的，可以直接用 python 跑，其他基本功能写写也很快

    * 难点在于让神经网络转换为 rknn，运行在 rk3568 自带的NPU上，环境配置超级麻烦

    * 摄像头驱动和 rknn 环境不兼容，呃，大家各显神通吧

    * 摄像头一直发烫，rk3568 也许什么时候会莫名其妙烧坏，所以写 lab 和 project 和验收要快，免得夜长梦多烧坏

## 任课教师

=== "翁恺"

    从程算、oop 一路到现在，想必大家对永平奖得主翁恺老师已经非常熟悉了。翁恺近年来喜欢在授课内容中掺水，并且逐渐只管授课，实验和作业逐渐下发助教，导致实验和作业体验很多时候要看助教人品。不过一般情况下，你还是可以相信 wk 的给分，20 级的嵌入式给分还是很好的。

=== "王总辉" 

    如果你不是实在想不开，**建议不要选择王总辉的嵌入式系统**。王总辉对待课程的态度从计逻应该可见一斑。20 级大部分佬都选择了翁恺班，导致王总辉班全靠 yy 大佬一人支撑。可以说，王总辉班的授课、实验、给分都全面落后于翁恺班。

    (特别澄清一下，靠一个人的努力是很难在 wzh 的课堂活下去的，实际上是大家结成统一战线，一致对外的结果。)

    让我们来简单介绍一下 wzh 老师的上课风格吧。选 wzh 课的人本来就很少，都是被挤过来的，只有可怜的 30 几个人，中间受不了他的迫害又走了一批，貌似最后就剩了 10 几个人吧，以至于我们期末考的时候考场人少的像开组会一样。再加上 wzh 的课堂内容忽略不计，很多人都翘课不来听，后面基本每次课上只有 7-8 个人的样子。

    首先，因为是早八的课， wzh 老师意识到大三的学生早八上课还是太残忍了，于是把上课时间改到了 8:30，导致当时我们普遍认为 wzh 老师还是一位非常和蔼可亲的老师。结果我们发现 wzh 上课主要就是念一下 PPT，再加上很多 PPT 都是描述性的内容和大段的代码，以至于他会直接跳过这部分，一开始几节课还可以将 60min 左右的课程内容，到了后来甚至出现只念 10-20 min，甚至干脆不上课的现象，主要原因是 PPT 都念完了，或者“我们的课程进度比隔壁班快了，所以我们停一次课，大家做实验吧”，相对于时不时吹水的 wk 老师， wzh 老师的课除了干货也很难有别的东西了。之后 10 点开始上实验课，实验课也是念 10 min 的 PPT，然后自己做实验。所以我们的上课模式最后就变成了，9 点左右来了 7-8 个人， wzh 念 10 min PPT，然后我们自己做实验，等 10 点左右上实验课，wzh 再念 10 min PPT，我们继续做实验，所以做好自学的准备吧。

    不过和他的实验相比，上课这些问题实在是不值一提，没错，前方高能，做好准备。我们的实验内容总体是和 wk 班一样，但是顺序和实验内容略有不同，但是 wk 班提供了详细的实验文档，包括详细的实验文档和实验教程，而我们只有一份寡淡的 PPT，上面只有密密麻麻的实验要求，甚至连实验要求都不说清楚。

    我们举几个例子：lab1 是要求配置 firefly-rk3568 的开发板，尝试烧板子、配置各种软件。老师，不会怎么办？PPT给了官网的网址，自己查！没错，他所有的实验指导一言蔽之就是 —— 自己查。更离谱的是，lab1 的一个实验要求是逐行注释 rk3568 里面 ubuntu 系统的开机代码，开机代码有多少行呢？区区 1600 行吧，我注释了整整 3 天，最后 lab1 的报告写了 99 页，其中 60 多页是开机代码注释。另一个同学的导师是这么评价这个离谱的作业的——“艹”。

    后面的 STM 编程也没有任何的教程，还好 wk 班的同学提供了环境配置和编程的教程，救了我们全班的狗命。离谱的事情还没有结束，STM 板子和 PC 机之间通信是依靠一块串口板的，但是 wzh 没发，一开始我用 rk3568 的串口板顶替了一下啊，然后串口输出非常奇怪，以至于我根本无法确定到底是 PC、STM、软件、串口中哪一部分的问题，于是又 debug 了一天一夜！最后我向 jjgg 借了 wk 班的串口板，一插，好了，通了。于是我去向 wzh 要板子，才知道，他一直以为 rk3568 的串口板是可以替代 STM32 的串口板的。然后我才知道，他和他的团队仅仅拍脑子设计了实验，他们根本没有自己验证一下实验的正确性。一个星期后，发了新的板子，于是我们的实验都拖了一个星期。

    最神奇的是用 rk3568 的 GPIO 来做外设 LED 矩阵驱动的 lab7 。第一个小部分是用一个库来驱动 rk3568 的 GPIO， 但是很尴尬的什么呢，往年使用树莓派做 GPIO 驱动的，这个库是可以用在树莓派上的，但是我们的是 rk3568，根本用不了这个东西，最后和助教交涉了一下，才把这部分要求改掉！之后是做 GPIO 的内核驱动，wzh 友好的给了我们前几届（经考证，不晚于 2016 年）学长的代码，那岂不是只要编译运行就可以了！然后就被当头泼了冷水，因为实验平台改了，这个代码根本跑不起来……改了 3 天，然后下板子运行，没有任何反应，人麻了。更离谱的是，rk3568 的引脚是需要配套的线才可以连接，我们发的杜邦线比 GPIO 引脚大一圈，根本接触不良，没法导电，于是我们去找老师反映。老师很迷茫：这个实验助教做过的呀？问助教：这个实验我没做过…… wzh 说：接触不良的话，你找一个同学帮你按住杜邦线，用点力，让他接触良好，应该可以解决这个问题吧？拜托，五根线呀，那个方寸之地都摆不下五只手！

    于是想起了一个古老的笑话：一天大领导过来的时候，一个坐轮椅的同志没有站起来鞠躬，他的领导批评他：领导来了你为什么不站起来鞠躬？小同志说，我腿断了。领导说：这位小同志，我知道你有困难，但是苦难是可以想办法克服的嘛！你虽然腿断了，但是可以努力一下，自己站起来的嘛！所以，虽然杜邦线大了一圈接触不良，你可以努力一下找 3 个同学帮你按一下线，克服一下的嘛。

    最后经过我们的据理力争，wzh 答应给我们买 rk3568 的专用线，让我们下周一来拿，最后我们下周五拿到了线，至此两个星期过去了。然后试了各种方法驱动，STM32 法、shell 法、gpio 文件法、内核 gpio 的 api 法，茴香豆的回字也就 4 种写法呀！但是 LED 矩阵都没有反应。gpio 波形测了一下没问题，线没问题，LED 矩阵看起来也没问题，到底问题出在哪？中间我们怎么逼迫助教和 wzh 改实验的部分就不展开了，反正他们垂死挣扎，坚决不改实验，哪怕他们没人做过，宁可去问厂家怎么回事。第八周的周五，我们要去造反的时候，意外的换了一块 LED 板子，然后它亮了，然后我们才知道，虽然 LED 写了 VCC 要求 5V，但实际上它只能接受 3V 左右，之前的 LED 因为接了 5V 都被烧坏了，至此，三周过去了。

    反正 wzh 就是拍着脑子想实验，他只负责想当然的设计实验内容，根本不在乎实验做不做得出来；而助教呢，根本没做过实验，也没有提供过实验教程，我们全靠 wk 班的教程苟命，找他验收的时候我们说什么，他就听什么，到了下半个学期，这位助教出差去了，临时换了一位研究生学长来验收，那就更什么都不知道了。他们根本就不尊重我们的劳动，也不在乎我们的付出和时间。如果你不小心选上了 wzh 的课，不要把他当老师，他是你的甲方，是个甩手掌柜，只管布置任务，还不付你工资。

    最后是给分，你以为这么痛苦之后老师会因为心怀愧疚或者体谅给个高分吗？并不。现在离作业截至过去 5 天了，还没有出分数，平时分只有 3-4 次报告作业出分了，结果一看：我写了 21 页报告、做完所有 bonus、第一个验收的 lab2 给了 95 分，写了 14 页报告、第一个验收、做完所有 bonus 的 lab8 给了 90 分......其他人比我还有糟糕。我们接受不了这个结果，去和助教反应，结果第二天所有分数变成不公布了。所以 wzh 评分：bonus 少做扣分，验收越晚扣分，篇幅不够长扣分，交了报告直接扣 5 分。

    所以，不要选 wzh！不要选 wzh！不要选 wzh！补选 wk 一般还是补选的上的。如果实在时乖命蹇选上了 wzh 的课，或者说等看到这篇文章你来不及退课了，那就送大家 16 字方针，“独立自主，自力更生，统一战线，斗争到底”，反正好好发扬你们的斗争精神，分数、权益和幸福都是自己争取来的。

## 课程教材

无。参考材料只有 PPT。

## 分数构成

=== "翁恺"

    20 级的各部分比例如下，相对 19 级而言期末考试的比例没变，但是平时分内部的比例有所变化。

    * 期末考试（30%）

    * 课内（10%）：包括考勤、课内讨论、课后小测，每周归一为 1 分，合计折算为 10 分

    * 实验（28%）：7 次，每次 4 分

    * 大程（32%）：4 次提交，每次各 7 分，共 28 分作为基本分；4 分为加分。

    20 级期末给了一个补充题目集，认真做了就能得 100 分，给平时分补 2 分。而除了补充题目集，20 级大程的基本分基本为 27 左右，课内和实验完成得好可以做到少于 1 分，即平时分还是容易满的，只要能够得到大程的加分。20 级大程加分的要求是实现组间网络的通信。

=== "王总辉" 

    20 级的各部分比例如下:

    * 期末考试（40%）

    * 课堂表现（5%）: 但是不知道怎么统计的

    * 实验（24%）: 8 次，每次 3 分

    * 作业（15%）: 15 次，每周 1 次，每次 1-2 道思考题

    * 大程（16%）

    在笔者撰写这篇文章时，最终给分还没出来，但是根据已经给分的几个 lab，wzh 给分并不好，所以最后的平时分估计较为堪忧


## 参考资料

主要就是 PPT，除此之外可以参考求是潮课程共享计划里的资料

- [求是潮课程共享计划 - 嵌入式系统](https://github.com/QSCTech/zju-icicles/tree/master/%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%B3%BB%E7%BB%9F)

## 学习建议

这课的 workload 极大，3 学分学出了 9 学分的感觉，平时的 7 个小实验还是比较密集的，难的实验至少需要一整天 all in，抽不出一整天就只能连着两三天做一个小实验。

20 级大程的大组管理比较困难，对于大组的领导者是一个不小的考验，如何统筹规划、分工设计让能力迥异的组员能够共同努力完成一个自组网系统，还是一个很困难的事情。在这过程中，还要积极进行组间协议的协商与磨合，以求得到 4 分的大程加分。20 级最后是 2 个大组实现了组间通信，另外 2 个大组只能勉强各做各的，总评 - 4。

在实际所得上，这门课可以学到的理论知识不是很多（相对 3 学分来说），很多时候可能算是操作系统和计网的进一步工程实践，阻止你做不出实验的往往是能力之外的一些垃圾因素。在具体给分上，20 级 wk 班的给分还是 nice 的，wzh 班相对会差一些。